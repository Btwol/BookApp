<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>BookApp</title>
    <base href="/" />
    <link href="css/bootstrap/bootstrap.min.css" rel="stylesheet" />
    <link href="css/app.css" rel="stylesheet" />
    <link href="BookApp.Client.styles.css" rel="stylesheet" />    

</head>

<body>
    <div id="app">Loading...</div>

    <div id="blazor-error-ui">
        An unhandled error has occurred.
        <a href="" class="reload">Reload</a>
        <a class="dismiss">ðŸ—™</a>
    </div>
    <script src="_framework/blazor.webassembly.js"></script>

    <script src="js/JavaScript.js"></script>
    <script src ="_content/Blazored.Modal/blazored.modal.js"></script>
    <script>

        function getLocation(elementId, startOffset, endOffset, textNodeNumber) {
            var element = document.getElementById(elementId);
            var textNode = getTextNodes(element)[textNodeNumber];

            var range = document.createRange();
            range.setStart(textNode, startOffset);
            range.setEnd(textNode, endOffset);
            var rect = range.getBoundingClientRect();

            return {
                left: rect.left,
                top: rect.top,
                width: rect.width,
                height: rect.height
            };
        }


        window.highlightText = {
            init: function (element) {
                const textContainer = element;
                const overlay = document.getElementById('overlay');

                function updateOverlayPosition() {
                    console.log("hit2");
                    const selection = window.getSelection();
                    const selectedText = selection.toString();
                    const range = selection.getRangeAt(0);
                    const rect = range.getBoundingClientRect();

                    if (selectedText !== '') {
                        const overlayStyle = overlay.style;
                        overlayStyle.display = 'block';
                        overlayStyle.width = rect.width + 'px';
                        overlayStyle.height = rect.height + 'px';
                        overlayStyle.top = rect.top + window.pageYOffset + 'px';
                        overlayStyle.left = rect.left + window.pageXOffset + 'px';
                    } else {
                        overlay.style.display = 'none';
                    }
                }

                textContainer.addEventListener('mouseup', updateOverlayPosition);
                window.addEventListener('resize', updateOverlayPosition);
            },

            createPermanentHighlight: function () {
                const selection = window.getSelection();
                const range = selection.getRangeAt(0);
                const span = document.createElement('span');
                span.style.background = 'yellow';
                span.appendChild(range.extractContents());
                range.insertNode(span);
            }
        };

    </script>

    <script>


        function getTextLocation(elementId) {
            var element = document.getElementById(elementId);
            var startOffset = 0, endOffset = 0;
            if (typeof window.getSelection != "undefined") {
                var range = window.getSelection().getRangeAt(0);
                var preCaretRange = range.cloneRange();
                preCaretRange.selectNodeContents(element);
                preCaretRange.setEnd(range.startContainer, range.startOffset);
                startOffset = preCaretRange.toString().length;
                endOffset = startOffset + range.toString().length;
            } else if (typeof document.selection != "undefined" &&
                document.selection.type != "Control") {
                var textRange = document.selection.createRange();
                var preCaretTextRange = document.body.createTextRange();
                preCaretTextRange.moveToElementText(element);
                preCaretTextRange.setEndPoint("EndToStart", textRange);
                startOffset = preCaretTextRange.text.length;
                endOffset = startOffset + textRange.text.length;
            }

            var location = {
                startOffset: startOffset,
                endOffset: endOffset
            };

            anotherScript(elementId, location);

            return { start: startOffset, end: endOffset };
        }
        function createHighlightedText(elementId, startOffset, endOffset) {
            var element = document.getElementById(elementId);
            var text = element.textContent;

            var highlightedText = text.substring(startOffset, endOffset);
            var beforeText = text.substring(0, startOffset);
            var afterText = text.substring(endOffset);

            var wrapperDiv = document.createElement('div');
            wrapperDiv.style.position = 'relative';
            wrapperDiv.style.display = 'inline-block';

            var highlightDiv = document.createElement('div');
            highlightDiv.style.position = 'absolute';
            highlightDiv.style.background = 'rgba(255, 0, 0, 0.3)';
            highlightDiv.style.width = element.getBoundingClientRect().width + 'px';
            highlightDiv.style.height = element.getBoundingClientRect().height + 'px';

            var textDiv = document.createElement('div');
            textDiv.style.position = 'relative';
            textDiv.textContent = highlightedText;

            wrapperDiv.appendChild(textDiv);
            wrapperDiv.appendChild(highlightDiv);

            element.innerHTML = '';
            element.appendChild(wrapperDiv);

            var updateHighlightPosition = function () {
                console.log("hit1");
                highlightDiv.style.width = element.getBoundingClientRect().width + 'px';
                highlightDiv.style.height = element.getBoundingClientRect().height + 'px';
            };

            window.addEventListener('resize', updateHighlightPosition);
        }




        function anotherScript(elementId, location) {
            var element = document.getElementById(elementId);
            var text = element.textContent;

            // Find the specific text using the location values
            var selectedText = text.substring(location.startOffset, location.endOffset);

            // Do something with the selected text, e.g., display or manipulate it
            console.log("Start position: ", location.startOffset);
            console.log("End position: ", location.endOffset);
            console.log("Selected text:", selectedText);
            // Perform other operations with the selected text as needed
        }

        function createHighlight(elementId, startOffset, endOffset) {
            var element = document.getElementById(elementId);
            var textNode = getTextNodes(element)[6]; // Get the first text node within the element
            var text = textNode.textContent;

            //for (let i = 0; i < 100; i++) {
            //    console.log(getTextNodes(element)[i].textContent.length);
            //}
            startOffset = 1;
            endOffset = 15;
            // Check if startOffset is out of bounds
            if (startOffset < 0 || startOffset >= text.length) {
                console.error("Invalid startOffset value");
                console.log(text.length);
                return;
            }

            // Check if endOffset is out of bounds
            if (endOffset <= startOffset || endOffset > text.length) {
                console.error("Invalid endOffset value");
                return;
            }

            // Find the specific text using the location values
            var selectedText = text.substring(startOffset, endOffset);

            // Create a span element to represent the highlight
            var highlight = document.createElement("div");
            highlight.className = "highlight";
            highlight.id = "newHighlight";
            //highlight.textContent = selectedText;

            // Get the position and dimensions of the specified text within the element
            var range = document.createRange();
            range.setStart(textNode, startOffset);
            range.setEnd(textNode, endOffset);
            var rect = range.getBoundingClientRect();

            // Position the highlight element on top of the specified text
            highlight.style.left = rect.left + "px";
            highlight.style.top = rect.top + "px";
            highlight.style.width = rect.width + "px";
            highlight.style.height = rect.height + "px";

            // Append the highlight element to the highlight container
            var highlightContainer = document.getElementById("highlightContainer");
            highlightContainer.appendChild(highlight);

            // Perform other operations with the selected text as needed
            console.log("Start position: ", startOffset);
            console.log("End position: ", endOffset);
            console.log("Selected text:", selectedText);


            var handleWindowResize = function () {
                console.log("hit");
                var element1 = document.getElementById("newHighlight");

                highlight.style.width = element1.getBoundingClientRect().width + 'px';
                highlight.style.height = element1.getBoundingClientRect().height + 'px';
            };

            window.addEventListener('resize', handleWindowResize);
        }

        //    // Event handler for window resize
        //function handleWindowResize() {
        //        var element = document.getElementById("newHighlight");
        //        var rect = element.getBoundingClientRect();
        //        element.style.width = rect.width + "px";
        //        element.style.height = rect.height + "px";

        //}

        // Helper function to get text nodes within an element
        function getTextNodes(element) {
            console.log(element);
            var textNodes = [];
            var walker = document.createTreeWalker(element, NodeFilter.SHOW_TEXT, null, false);

            while (walker.nextNode()) {
                textNodes.push(walker.currentNode);
            }

            return textNodes;
        }

    </script>

    <script>
        function Test(highlight) {
            console.log(highlight);

            var testElement = document.createElement(highlight.elementType);
            highlight.reference = testElement;
            testElement.id = "1";
            console.log(highlight);
            return highlight;
        }
    </script>

    <script>
        window.deleteElementById = function (elementId) {
            var element = document.getElementById(elementId);
            if (element) {
                element.remove();
                return true;
            }
            return false;
        }

        //deletes pernament highlight
        window.deletePernamentHighlight = function (elementId, nodes) {
            console.log(elementId);
            console.log(nodes);
            if (nodes == 1) {
                var element = document.getElementById(elementId + "_s");
                console.log("delete hit!");
                if (element) {
                    console.log("delete hit!");
                    element.remove();
                    return;
                }
                return;
            }

            var element = document.getElementById(elementId + '_f');
            if (element) {
                element.remove();
            }

            for (let i = 1; i < nodes - 1; i++) {
                element = document.getElementById(elementId + '_' + i);
                if (element) {
                    element.remove();
                }
            }

            element = document.getElementById(elementId + '_l');
            if (element) {
                element.remove();
            }

            return;
        }
    </script>

    <script>

        function getSelectedTextNodeIndex(element) {
            var selectedText = window.getSelection().toString();

            if (selectedText.length > 0) {
                var range = window.getSelection().getRangeAt(0);
                var textNodes = getTextNodes(element);
                var firstNode, lastNode;

                for (var i = 0; i < textNodes.length; i++) {
                    if (range.intersectsNode(textNodes[i])) {
                        lastNode = i;
                    }
                }

                for (var i = textNodes.length - 1; i > 0; i--) {
                    if (range.intersectsNode(textNodes[i])) {
                        firstNode = i;
                    }
                }

                var locations = [];

                var firstNodeCharIndex = getFirstHighlightedCharacterIndex(element);
                locations.push([firstNode, firstNodeCharIndex]);

                for (var i = firstNode + 1; i < lastNode; i++) {
                    locations.push([i, textNodes[i].textContent.length]);
                }

                var lastNodeCharIndex = getLastHighlightedCharacterIndex(element);
                locations.push([lastNode, lastNodeCharIndex]);

                return locations;
            }

            return -1; // No text node found
        }

        function getTextNodes(element) {
            var textNodes = [];
            var walker = document.createTreeWalker(element, NodeFilter.SHOW_TEXT, null, false);

            while (walker.nextNode()) {
                textNodes.push(walker.currentNode);
            }

            return textNodes;
        }

        function getFirstHighlightedCharacterIndex(highlightedDiv) {
            //const highlightedDiv = document.getElementById(elementId);
            const selection = window.getSelection();

            if (selection.rangeCount > 0) {
                const range = selection.getRangeAt(0);
                const allTextNodes = getTextNodesInElement(highlightedDiv);
                let firstTextNode = null;
                let firstCharacterIndex = -1;

                for (const textNode of allTextNodes) {
                    const text = textNode.textContent;
                    const nodeRange = document.createRange();
                    nodeRange.selectNodeContents(textNode);

                    if (nodeRange.compareBoundaryPoints(Range.END_TO_END, range) >= 0) {
                        // The text node contains the first highlighted character
                        const startOffset = Math.max(0, range.startOffset - nodeRange.startOffset);
                        firstTextNode = textNode;
                        firstCharacterIndex = startOffset;
                        break;
                    }

                    nodeRange.detach();
                }

                //console.log("First Text Node:", firstTextNode);
                //console.log("Character Index within First Text Node:", firstCharacterIndex);
                return firstCharacterIndex;
            }
        }

        function getLastHighlightedCharacterIndex(highlightedDiv) {
            const selection = window.getSelection();

            if (selection.rangeCount > 0) {
                const range = selection.getRangeAt(0);
                const allTextNodes = getTextNodesInElement(highlightedDiv);
                let lastTextNode = null;
                let lastCharacterIndex = -1;

                for (const textNode of allTextNodes) {
                    const text = textNode.textContent;
                    const nodeRange = document.createRange();
                    nodeRange.selectNodeContents(textNode);

                    if (nodeRange.compareBoundaryPoints(Range.START_TO_START, range) >= 0) {
                        // The text node contains the last highlighted character
                        const endOffset = Math.max(0, range.endOffset - nodeRange.startOffset);
                        lastTextNode = textNode;
                        lastCharacterIndex = endOffset;
                    }

                    nodeRange.detach();
                }

                console.log("Last Text Node:", lastTextNode);
                console.log("Character Index within Last Text Node:", lastCharacterIndex);

                return lastCharacterIndex;
            }
        }


        function getTextNodesInElement(element) {
            const textNodes = [];
            const treeWalker = document.createTreeWalker(element, NodeFilter.SHOW_TEXT, null, false);

            let node;
            while ((node = treeWalker.nextNode())) {
                textNodes.push(node);
            }

            return textNodes;
        }

    </script>


    <script>
        function getOffset(el) {
            const rect = el.getBoundingClientRect();
            return {
                left: rect.left + window.scrollX,
                top: rect.top + window.scrollY
            };
        }

        let placeholderString = "a";
        //FirstNodeIndex, FirstNodeCharIndex, LastNodeIndex, LastNodeCharIndex, RawArray
        function createHighlight2(elementId, firstNodeIndex, firstNodeCharIndex, lastNodeIndex, lastNodeCharIndex, dotNetHelper, highlightId) {

            var nodeCount = lastNodeIndex - firstNodeIndex + 1;

            //SINGLE NODE
            if (nodeCount == 1) {
                var element = document.getElementById(elementId);
                var textNode = getTextNodes(element)[firstNodeIndex];
                var text = textNode.textContent;

                startOffset = firstNodeCharIndex;
                endOffset = lastNodeCharIndex;

                // Find the specific text using the location values
                var selectedText = text.substring(startOffset, endOffset);

                // Create a span element to represent the highlight
                var highlight = document.createElement("div");
                highlight.className = "highlight";
                highlight.id = highlightId + '_s';
                highlight.onclick = function () { { dotNetHelper.invokeMethodAsync("onPernamentHighlightClick", highlightId); } };

                // Get the position and dimensions of the specified text within the element
                var range = document.createRange();
                range.setStart(textNode, startOffset);
                range.setEnd(textNode, endOffset);
                var rect = range.getBoundingClientRect();
                

                // Position the highlight element on top of the specified text
                highlight.style.left = rect.left + "px";
                highlight.style.top = rect.top + "px";
                highlight.style.width = rect.width + "px";
                highlight.style.height = rect.height + "px";

                // Append the highlight element to the highlight container
                var highlightContainer = document.getElementById("textContainer");
                highlightContainer.appendChild(highlight);

                var aaa = getOffset(highlight);
                console.log("H top: " + rect.top);
                console.log("H left: " + rect.left);
                console.log("ITEM top: " + aaa.top);
                console.log("ITEM left: " + aaa.left);

                var textboxOffset = getOffset(element);
                console.log("textboxOffset top: " + textboxOffset.top);
                console.log("textboxOffset left: " + textboxOffset.left);

                return;
            }

            //FIRST NODE
            var element = document.getElementById(elementId);
            var textNode = getTextNodes(element)[firstNodeIndex]; // Get the first text node within the element
            var text = textNode.textContent;

            startOffset = firstNodeCharIndex;
            endOffset = text.length

            // Find the specific text using the location values
            var selectedText = text.substring(startOffset, endOffset);

            // Create a span element to represent the highlight
            var highlight = document.createElement("div");
            highlight.className = "highlight";
            highlight.id = highlightId + '_f';
            highlight.onclick = function () { { dotNetHelper.invokeMethodAsync("onPernamentHighlightClick", highlightId); } };

            // Get the position and dimensions of the specified text within the element
            var range = document.createRange();
            range.setStart(textNode, startOffset);
            range.setEnd(textNode, endOffset);
            var rect = range.getBoundingClientRect();

            // Position the highlight element on top of the specified text
            highlight.style.left = rect.left + "px";
            highlight.style.top = rect.top + "px";
            highlight.style.width = rect.width + "px";
            highlight.style.height = rect.height + "px";

            // Append the highlight element to the highlight container
            var highlightContainer = document.getElementById("highlightContainer");
            highlightContainer.appendChild(highlight);

            //NODES IN BETWEEN
            for (let i = 1; i < nodeCount - 1; i++) {
                var element = document.getElementById(elementId);
                var textNode = getTextNodes(element)[firstNodeIndex + i]; // Get the first text node within the element
                var text = textNode.textContent;

                startOffset = 0;
                endOffset = text.length

                // Find the specific text using the location values
                var selectedText = text.substring(startOffset, endOffset);

                // Create a span element to represent the highlight
                var highlight = document.createElement("div");
                highlight.className = "highlight";
                highlight.id = highlightId + '_' + i;
                highlight.onclick = function () { { dotNetHelper.invokeMethodAsync("onPernamentHighlightClick", highlightId); } };

                // Get the position and dimensions of the specified text within the element
                var range = document.createRange();
                range.setStart(textNode, startOffset);
                range.setEnd(textNode, endOffset);
                var rect = range.getBoundingClientRect();

                // Position the highlight element on top of the specified text
                highlight.style.left = rect.left + "px";
                highlight.style.top = rect.top + "px";
                highlight.style.width = rect.width + "px";
                highlight.style.height = rect.height + "px";

                // Append the highlight element to the highlight container
                var highlightContainer = document.getElementById("highlightContainer");
                highlightContainer.appendChild(highlight);
            }

            //LAST NODE
            var element = document.getElementById(elementId);
            var textNode = getTextNodes(element)[lastNodeIndex]; // Get the first text node within the element
            var text = textNode.textContent;

            startOffset = 0;
            endOffset = lastNodeCharIndex

            // Find the specific text using the location values
            var selectedText = text.substring(startOffset, endOffset);

            // Create a span element to represent the highlight
            var highlight = document.createElement("div");
            highlight.className = "highlight";
            highlight.id = highlightId + '_l';
            highlight.onclick = function () { { dotNetHelper.invokeMethodAsync("onPernamentHighlightClick", highlightId); } };

            // Get the position and dimensions of the specified text within the element
            var range = document.createRange();
            range.setStart(textNode, startOffset);
            range.setEnd(textNode, endOffset);
            var rect = range.getBoundingClientRect();

            // Position the highlight element on top of the specified text
            highlight.style.left = rect.left + "px";
            highlight.style.top = rect.top + "px";
            highlight.style.width = rect.width + "px";
            highlight.style.height = rect.height + "px";

            // Append the highlight element to the highlight container
            var highlightContainer = document.getElementById("highlightContainer");
            highlightContainer.appendChild(highlight);
        }
    </script>

    <script>
        //Clears highlight child divs after changing page
        function clearDiv(elementId) {
            const div = document.getElementById(elementId);

            // Remove all child elements from the div
            while (div.firstChild) {
                div.removeChild(div.firstChild);
            }
        }

        //check if pernament highlight already rendered
        function doesHighlightExist(elementId) {
            if (document.getElementById(elementId + '_s') !== null || document.getElementById(elementId + "_f") !== null) {
                return true;
            }
            else return false;
        }

        function showContextMenu(dotNetHelper) {
            var contextMenu = document.getElementById("contextMenu");
            contextMenu.style.display = "block";
            const rect = contextMenu.getBoundingClientRect();
            //contextMenu.style.left = rect.left + 'px';
            //contextMenu.style.top = rect.top + 'px';
            document.addEventListener('click', (event) => {
                const clickedOutside = !contextMenu.contains(event.target);
                const clickedOnNotes = document.getElementById("noteContainer").contains(event.target); //Notes container
                let highlightClicked = event.target.id.startsWith("pernamentHighlight_");
                if (clickedOutside && !highlightClicked && !clickedOnNotes) {
                    contextMenu.style.display = "none";
                    dotNetHelper.invokeMethodAsync("onPernamentHighlightClickOff");
                }
            });
        }

    </script>

    <script>
        //Script to determine which text node was clicked
        let lastSelectedNodeIndex = -1;
        let lastSelectedNode;

        // Function to get the text node number
        function getTextNodeNumber(event) {
            var range = window.getSelection().getRangeAt(0);
            var element = document.getElementById('textContainer');
            var textNodes = getTextNodes(element);
            var firstNode;

            for (var i = textNodes.length - 1; i > 0; i--) {
                if (range.intersectsNode(textNodes[i])) {
                    firstNode = i;
                }
            }

            console.log("Fisrt Node: " + firstNode);
            lastSelectedNode = event.target;
            lastSelectedNodeIndex = firstNode;

            //retrieve position of clicked text node
            var element = document.getElementById('textContainer');
            var textNode = getTextNodes(element)[lastSelectedNodeIndex + i]; // Get the first text node within the element
            var range = document.createRange();
            range.setStart(textNode, 0);
            range.setEnd(textNode, 0);
            var rect = range.getBoundingClientRect();

            dotNet.invokeMethodAsync("onTextNodeClick", lastSelectedNodeIndex, rect.left, rect.top);
        }

        // Attach event listener to the parent div
        let parentDiv;
        //= document.getElementById('textContainer');
        //parentDiv.addEventListener('click', getTextNodeNumber);

        let dotNet;
        function setupEvent(elementId, dotNetInit) {
            console.log("Element Id: " + elementId);
            parentDiv = document.getElementById(elementId);
            console.log(parentDiv);
            parentDiv.addEventListener('click', getTextNodeNumber);
            dotNet = dotNetInit;
            document.addEventListener('scroll', function (e) { dotNet.invokeMethodAsync("ReRender"); }, true);
        }

        function setAddParagraphNotePosition(left, top, elementId) {
            element = document.getElementById(elementId);
            element.style.left = left-100 + 'px';
            element.style.top = top + 'px';
            element.style.display = 'block';
        }

        function getNodeIndex(node) {
            let index = 0;
            while ((node = node.previousSibling) !== null) {
                index++;
            }
            return index;
        }

        function retrieveLastClickedNode(dotNetHelper) {
            dotNetHelper.invokeMethodAsync("GetClickedNodeIndex", lastSelectedNodeIndex);
        }

        function addNote() {
            console.log("Adding Note...");
            var note = document.createElement("div");
            note.className = "highlight";
            note.id = "newNote";
            //highlight.onclick = function () { { dotNetHelper.invokeMethodAsync("onPernamentHighlightClick", highlightId); } };

            console.log(lastSelectedNode);

            //// Get the position and dimensions of the specified text within the element
            //var range = document.createRange();
            //range.setStart(textNode, startOffset);
            //range.setEnd(textNode, endOffset);
            //var rect = range.getBoundingClientRect();

            var element = document.getElementById('textContainer');
            var textNode = getTextNodes(element)[lastSelectedNodeIndex]; // Get the first text node within the element
            console.log(element);
            var range = document.createRange();
            range.setStart(textNode, 0);
            range.setEnd(textNode, 0);
            var rect = range.getBoundingClientRect();

            // Position the highlight element on top of the specified text
            note.style.left = rect.left - 50 + "px";
            note.style.top = rect.top + "px";
            note.style.width = 100 + "px";
            note.style.height = rect.height + "px";

            // Append the highlight element to the highlight container
            var highlightContainer = document.getElementById("noteContainer");
            highlightContainer.appendChild(note);
        }
    </script>

    <script>
        window.attachHandlers = () => {
            document.getElementById("textContainer").addEventListener('click', getTextNodeNumber);
        };
    </script>

    <script>
        window.localStorageFunctions = {
            setItem: function (key, value) {
                localStorage.setItem(key, value);
            },
            getItem: function (key) {
                return localStorage.getItem(key);
            },
            removeItem: function (key) {
                localStorage.removeItem(key);
            }
        };

        function reloadPage() {
            location.reload();
        }

        window.openNewWindow = function (url, target) {
            window.open(url, target);
        };
    </script>
</body>



</html>

